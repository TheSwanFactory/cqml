cqml: 0.2
id: cqml_test
meta:
    org: nauto
    project: sangam
    s3.bucket: biz-databricks-root-prod-us
    catalog: quilt
    root: /dbfs/tmp
actions:
  nauto:
    do: latest
    cols:
      hardware: unique oh
    tables:
      devs: unique_devices
  google_sheets:
    do: load
    tables:
      n2_returns: projected_inventory
  /Workspace/Repos/ernest.prabhakar@nauto.com/cqml/data:
    do: loadfiles
    as_number: devices
    tables:
      test1: test1.csv
      test2: test2.csv
  box_details:
    do: box
    from: test1
    group: num
    +doc: Split by num, upload, store URLs
    box:
        root_folder: CQML_Test
        root_id: 156760265584
        data_dir: test
        file_ext: csv
        expiration_date: '2200-02-02'
    cols:
      text: sort
      dat: sort
  macro_def:
    do: macro|merge
    into: "{into}"
    join: "{join}"
    from: test2
    join_type: inner
    cols:
      "{join}": tbd
      num|numerate: tbd
      text|texas: tbd
      dat|database: tbd
  macro_run:
    do: macro.macro_def
    into: test1
    join: letter
    char: A
  mult_number:
    do: assign
    from: macro_run
  grouped:
    do: group
    from: test1
    agg:
      num: sum
      dat: max
    sort: max_dat
    cols:
      text: tbd
      letter: tbd
  pivoted:
    do: pivot
    from: $id
    agg:
      sum_num: count
    sort: max_dat
    pivot: letter
    cols:
      text: tbd
  cqml_test_summarize:
    do: summary
    save: [grid, parquet]
    from: test1
    count: num
    as: total
    cols:
      letter: tbd
      text: tbd
  selected:
    do: select
    from: test1
    where:
      letter:
        A: contains
        B: contains
      text:
        null: is_not
    cols:
      num: tbd
      date: tbd
      letter: tbd
      text: tbd
  merged:
    do: merge
    save: grid
    into: test1
    join: num
    from: test2
    join_type: inner
    where:
      letter:
        A: contains
    cols:
      num|next: tbd
      letter|better: tbd
      dat|dot: tbd
  flagged:
    do: flag
    from: test1
    where:
      text:
        null: is
  count_days:
    do: call
    from: test1
    function: datediff
    args:
        - current_date()
        - dat
  check_count:
    do: flag
    from: $id
    where:
      count_days:
        0: greater
  aggregates:
    do: group
    from: $id
    agg:
      check_call: count
      count_days: sum
    sort: n_check_count
    cols:
      num: tbd
      letter: tbd
  leftsemi_match:
    do: select
    from: test1
    matching:
      num:
          test2: num
  unique_num:
    do: unique
    from: test1
    sort: dat
    ensure_unique: num
    cols:
      num: tbd
  union:
    do: union
    into: test1
    from: test2
    drop:
      - note
  plus_operator:
    do: call
    from: mult_number
    operator: +
    args:
        - numerate
        - num
  calc_quarters:
    do: calc
    from: plus_operator
    operator: /
    round: 3
    else: 0
    args:
        - $col
        - 4
    cols:
      num: qnum
      numerate: qnumb
      plus_operator: qdumb
